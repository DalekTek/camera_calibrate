# Теория калибровки камеры для новичков

## Что такое калибровка камеры?

Калибровка камеры - это процесс определения внутренних параметров камеры и устранения искажений (дисторсий), которые возникают при съемке. Представьте, что камера - это глаз, который видит мир не совсем так, как он есть на самом деле. Калибровка помогает "научить" компьютер понимать, как именно видит камера.

## Зачем нужна калибровка?

### Основные проблемы некалиброванной камеры:

1. **Искажения изображения**: Прямые линии выглядят изогнутыми (особенно по краям)
2. **Неточные измерения**: Невозможно точно измерить расстояния и размеры объектов
3. **Проблемы с 3D-реконструкцией**: Нельзя точно определить положение объектов в пространстве

### Применения калиброванной камеры:

- **Компьютерное зрение**: распознавание объектов, их размеров и положения
- **Робототехника**: навигация роботов, захват объектов
- **Дополненная реальность (AR)**: точное наложение виртуальных объектов
- **Фотограмметрия**: создание 3D-моделей по фотографиям
- **Автомобильная промышленность**: системы помощи водителю

## Математическая модель камеры

### 1. Внутренние параметры (Intrinsic Parameters)

Это характеристики самой камеры, которые не зависят от того, что мы снимаем:

#### Матрица камеры (Camera Matrix):
```
K = [fx  0  cx]
    [0  fy  cy]
    [0   0   1]
```

**Что означают параметры:**

- **fx, fy** - фокусное расстояние в пикселях по осям X и Y
  - Показывает, насколько сильно камера "увеличивает" изображение
  - Чем больше значение, тем больше увеличение
  - fx ≠ fy если пиксели матрицы не квадратные

- **cx, cy** - главная точка (где оптическая ось пересекает матрицу)
  - Обычно находится примерно в центре изображения
  - Но может смещаться из-за неточной сборки камеры

### 2. Коэффициенты дисторсии (Distortion Coefficients)

Описывают, как камера искажает изображение:

```
[k1, k2, p1, p2, k3]
```

**Типы искажений:**

#### Радиальная дисторсия (k1, k2, k3):
- **Бочкообразная дисторсия** (k1 < 0): изображение "раздувается" по краям
- **Подушкообразная дисторсия** (k1 > 0): изображение "сжимается" к центру
- k2, k3 - коррекция более высокого порядка

#### Тангенциальная дисторсия (p1, p2):
- Возникает из-за неточного параллельного расположения линз
- Приводит к наклону изображения

### 3. Внешние параметры (Extrinsic Parameters)

Описывают положение и ориентацию камеры в пространстве для каждого снимка:

- **Вектор поворота (R)**: как камера повернута относительно объекта
- **Вектор перемещения (T)**: где находится камера относительно объекта

## Процесс калибровки

### Шаг 1: Подготовка калибровочного паттерна

**Почему шахматная доска?**
- Простая для автоматического обнаружения
- Четкие углы (пересечения черных и белых квадратов)
- Регулярная структура с известными размерами

**Важные параметры:**
- Размер доски измеряется в **внутренних углах** (не в квадратах!)
- Стандартная доска 10×7 квадратов = 9×6 внутренних углов

### Шаг 2: Съемка калибровочных изображений

**Правила качественной съемки:**

1. **Количество**: минимум 10 изображений, лучше 20-30
2. **Разнообразие ракурсов**:
   - Разные углы наклона доски
   - Разные расстояния до камеры
   - Доска в разных частях кадра
3. **Качество**:
   - Вся доска должна быть в кадре
   - Четкий фокус, без размытия
   - Хорошее освещение без бликов

### Шаг 3: Обнаружение углов

Алгоритм автоматически находит углы шахматной доски на каждом изображении:

1. **Грубое обнаружение**: поиск примерных координат углов
2. **Уточнение**: точное определение координат с субпиксельной точностью
3. **Сохранение**: запоминаются 2D-координаты на изображении

### Шаг 4: Соответствие 3D ↔ 2D точек

Для каждого угла мы знаем:
- **3D-координаты** в реальном мире (например, угол (0,0,0), (1,0,0), (2,0,0)...)
- **2D-координаты** на изображении (в пикселях)

### Шаг 5: Математическая оптимизация

Алгоритм подбирает параметры камеры так, чтобы:
- 3D-точки, спроецированные через модель камеры, максимально точно совпадали с найденными 2D-точками
- Используется метод наименьших квадратов

## Оценка качества калибровки

### Ошибка репроекции (Reprojection Error)

Это главный показатель качества:

1. Берем 3D-точки реального мира
2. Проецируем их на изображение через найденную модель камеры
3. Сравниваем с реально найденными 2D-точками
4. Вычисляем среднее расстояние между ними

**Интерпретация:**
- **< 0.5 пикселя** - отличная калибровка
- **0.5-1.0 пикселя** - хорошая калибровка  
- **> 1.0 пикселя** - посредственная, нужно больше изображений

### Типичные проблемы и решения

**Высокая ошибка репроекции:**
- Мало изображений → снимите больше
- Однообразные ракурсы → разнообразьте углы съемки
- Плохое качество изображений → улучшите освещение и фокус
- Неточная шахматная доска → используйте качественный принт

**Неразумные значения параметров:**
- fx и fy сильно отличаются → проверьте, что пиксели квадратные
- cx, cy далеко от центра → возможно, проблема с оптикой камеры
- Очень большие коэффициенты дисторсии → камера сильно искажает

## Применение результатов калибровки

### 1. Исправление дисторсии

После калибровки можно "выпрямить" любое изображение:
- Устранить бочкообразные/подушкообразные искажения
- Сделать прямые линии действительно прямыми

### 2. Измерения в реальном мире

Зная параметры камеры, можно:
- Измерять реальные размеры объектов на фото
- Определять расстояния до объектов
- Вычислять углы между объектами

### 3. 3D-реконструкция

С калиброванной камерой возможно:
- Определение позы объектов (где находится, как повернут)
- Стереозрение (глубина по двум изображениям)
- SLAM (одновременная локализация и картирование)

## Практические советы

### Для качественной калибровки:

1. **Используйте хорошую шахматную доску**:
   - Точно напечатанную (не растянутую/сжатую)
   - На плоской поверхности
   - Контрастную (четкие черно-белые квадраты)

2. **Снимайте разнообразно**:
   - Покрывайте всю область кадра
   - Разные углы наклона
   - Разные расстояния
   - Доска должна занимать 20-80% кадра

3. **Следите за качеством**:
   - Без размытия и шевеленки
   - Равномерное освещение
   - Все углы доски видны

4. **Сохраняйте результаты**:
   - Параметры калибровки не изменяются для конкретной камеры
   - Достаточно откалибровать один раз для каждой камеры
   - При смене объектива нужна новая калибровка

### Частые ошибки новичков:

1. **Неправильный размер паттерна**: помните, что размер - это внутренние углы, не квадраты
2. **Мало изображений**: минимум 10, но лучше 20-30
3. **Однообразные ракурсы**: все фото с одного расстояния и угла
4. **Плохое качество**: размытые или темные изображения
5. **Неплоская доска**: изогнутая или помятая калибровочная доска

Калибровка камеры - это основа многих задач компьютерного зрения. Потратив время на качественную калибровку один раз, вы получите точный инструмент для множества интересных проектов!