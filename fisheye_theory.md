# Теория Fisheye камер и их калибровки

## Что такое Fisheye камера?

**Fisheye камера** (рыбий глаз) - это камера с **экстремально широким углом обзора**, обычно 180° или больше. Название происходит от того, что изображение напоминает вид из-под воды через выпуклый глаз рыбы.

### Основные характеристики:
- **Поле зрения (FOV)**: 180° - 220°
- **Сильные радиальные искажения**: прямые линии выглядят изогнутыми
- **Специальная оптика**: использует особые линзы для захвата широкого поля зрения

## Отличия от обычных камер

### Обычная камера:
- FOV: 30° - 80°
- Небольшие искажения по краям
- Стандартная модель дисторсии (5 параметров)
- Цель: максимально реалистичное изображение

### Fisheye камера:
- FOV: 180° - 220°
- Экстремальные искажения по всему изображению
- Специальная модель дисторсии (4 параметра)
- Цель: захват максимального поля зрения

## Математическая модель Fisheye

### 1. Внутренние параметры (такие же как у обычной камеры)

```
K = [fx  0  cx]
    [0  fy  cy]
    [0   0   1]
```

- **fx, fy**: фокусное расстояние в пикселях
- **cx, cy**: главная точка (центр проекции)

### 2. Автомобильная промышленность
- **Применения**: системы кругового обзора, парковочные ассистенты
- **Задачи**: обнаружение препятствий, слепых зон
- **Особенности**: реальное время, высокая надежность

### 3. Виртуальная и дополненная реальность (VR/AR)
- **Применения**: съемка 360° контента, стереоскопические системы
- **Задачи**: создание иммерсивного контента
- **Особенности**: требуется точная калибровка для отсутствия тошноты

### 4. Робототехника и дроны
- **Применения**: навигация, SLAM (локализация и картирование)
- **Задачи**: обход препятствий, построение карт окружения
- **Особенности**: компактность, широкий обзор

### 5. Научные исследования
- **Применения**: астрономия, метеорология, биология
- **Задачи**: наблюдение за небом, погодными явлениями
- **Особенности**: точные измерения углов и направлений

### 6. Медицина
- **Применения**: эндоскопия, минимально инвазивная хирургия
- **Задачи**: осмотр внутренних органов
- **Особенности**: миниатюризация, биосовместимость

## Оценка качества калибровки Fisheye

### Метрики качества:

#### 1. RMS ошибка репроекции
- **Хорошо**: < 0.5 пикселя
- **Приемлемо**: 0.5-1.5 пикселя  
- **Плохо**: > 2.0 пикселя

#### 2. Анализ коэффициентов дисторсии
```python
# Типичные значения для fisheye:
k1: -0.1 до -0.8 (основной fisheye коэффициент)
k2: -0.05 до 0.1 (коррекция средних углов)
k3: -0.01 до 0.05 (коррекция больших углов)  
k4: -0.005 до 0.01 (коррекция экстремальных углов)
```

#### 3. Поле зрения (FOV)
- **180°**: стандартная fisheye
- **190-200°**: широкая fisheye
- **> 200°**: сверхширокая fisheye

### Проблемы и их решения:

#### Высокая ошибка репроекции:
- **Причины**: недостаточно изображений, плохое покрытие поля зрения
- **Решение**: больше изображений с доской в разных частях кадра

#### Неразумные коэффициенты:
- **k1 > 0**: возможно, это не fisheye камера
- **Экстремальные значения**: проверить качество изображений

#### Плохое покрытие углов:
- **Проблема**: доска только в центре кадра
- **Решение**: съемка с доской у краев и в углах

## Практические советы для Fisheye калибровки

### Подготовка оборудования:

1. **Шахматная доска**:
   - Размер: минимум 9×6 внутренних углов
   - Качество печати: высокое разрешение, точные размеры
   - Материал: жесткий картон или пластик (не мнется)

2. **Освещение**:
   - Равномерное освещение по всему полю зрения
   - Избегать бликов на доске
   - Достаточная яркость для четкого изображения

### Стратегия съемки:

#### Этап 1: Центральная область (3-5 изображений)
- Доска в центре кадра
- Разные расстояния
- Разные углы наклона

#### Этап 2: Средняя область (5-8 изображений)  
- Доска смещена от центра
- Покрытие различных секторов
- Умеренные углы наклона

#### Этап 3: Периферийная область (7-10 изображений)
- Доска у краев кадра
- Доска в углах
- Экстремальные ракурсы

#### Этап 4: Проверочные изображения (3-5 изображений)
- Комбинированные положения
- Проверка сложных случаев

### Контроль качества во время съемки:

1. **Проверка обнаружения углов**:
   ```python
   ret, corners = cv2.findChessboardCorners(gray, pattern_size)
   if ret:
       print("✓ Углы найдены")
   else:
       print("✗ Переснимите изображение")
   ```

2. **Визуальная проверка**:
   - Все углы доски четко видны
   - Нет размытия или засветки
   - Доска не обрезана краями кадра

3. **Покрытие поля зрения**:
   - Равномерное распределение изображений
   - Особое внимание к краям и углам

## Сравнение моделей камер

| Характеристика | Обычная камера | Fisheye камера |
|---|---|---|
| **Поле зрения** | 30°-80° | 180°-220° |
| **Модель дисторсии** | 5 параметров [k1,k2,p1,p2,k3] | 4 параметра [k1,k2,k3,k4] |
| **Функции OpenCV** | `cv2.calibrateCamera()` | `cv2.fisheye.calibrate()` |
| **Минимум изображений** | 10 | 15-20 |
| **Основное искажение** | По краям | По всему изображению |
| **Цель калибровки** | Устранение искажений | Понимание проекции |
| **Сложность** | Средняя | Высокая |

## Отладка проблем Fisheye калибровки

### Проблема: Калибровка не сходится

**Симптомы**: 
- Ошибка `cv2.error: assertion failed`
- Очень высокая RMS ошибка
- Неразумные значения параметров

**Решения**:
1. Проверить правильность размера доски (внутренние углы!)
2. Убедиться в качестве изображений
3. Добавить флаг `cv2.fisheye.CALIB_CHECK_COND`
4. Увеличить количество изображений

### Проблема: Плохое качество исправления дисторсии

**Симптомы**:
- Неестественно выглядящие исправленные изображения
- Сильные искажения после исправления
- Потеря важных частей изображения

**Решения**:
1. Попробовать разные методы проекции
2. Настроить параметр `balance` в `estimateNewCameraMatrixForUndistortRectify`
3. Использовать область интереса (ROI)
4. Пересмотреть стратегию применения

### Проблема: Низкая точность в краевых областях

**Симптомы**:
- Хорошая калибровка в центре, плохая по краям
- Высокие остаточные ошибки для крайних точек

**Решения**:
1. Больше изображений с доской у краев
2. Использовать доску большего размера
3. Проверить качество объектива (возможны аберрации)

## Продвинутые техники

### 1. Мульти-камерная Fisheye система
```python
# Калибровка стерео fisheye системы
cv2.fisheye.stereoCalibrate()
```

### 2. Оптимизация параметров калибровки
```python
# Фиксация определенных параметров
flags = cv2.fisheye.CALIB_FIX_K1 | cv2.fisheye.CALIB_FIX_K2
```

### 3. Интерактивная калибровка
- Реальное время предпросмотр исправления
- Динамическая оценка качества
- Автоматическое определение оптимальных параметров
